import{s as S,u as k,r as h,R as s}from"./index-DRHptiz6.js";import{a as N,g as _}from"./allergyService-Bj9Hg86d.js";const F="https://world.openfoodfacts.org/cgi/search.pl",g=(a="")=>a.toString().toLowerCase().trim();function C(a){if(Array.isArray(a==null?void 0:a.ingredients)&&a.ingredients.length){const n=a.ingredients.map(e=>(e==null?void 0:e.text)||(e==null?void 0:e.id)||(e==null?void 0:e.name)||"").map(e=>g(e)).filter(Boolean);if(n.length)return n}return a!=null&&a.ingredients_text?a.ingredients_text.toString().toLowerCase().split(/,|;|\(|\)|\n/).map(n=>n.trim()).filter(Boolean):[]}async function v(a,n=10){const e=`${F}?search_terms=${encodeURIComponent(a)}&search_simple=1&action=process&page_size=${n}&json=1`,d=await fetch(e);if(!d.ok)throw new Error(`OFF search failed: ${d.status}`);return(await d.json()).products||[]}async function E(a,n){const e={};for(const d of n){const f=await N(a,d),c=[];f.forEach(r=>{r.product_name&&c.push(g(r.product_name)),r.ingredients_text&&r.ingredients_text.toString().toLowerCase().split(/,|;|\(|\)|\n/).map(m=>m.trim()).filter(Boolean).forEach(m=>c.push(g(m)))}),e[d]=[...new Set(c)]}return e}function b(a,n=[],e={},d=[],f=[]){const c=new Set,r=a.map(g),m=o=>{var l,t;return((t=o==null?void 0:(l=o.toString().split(":")).pop)==null?void 0:t.call(l))||g(o)},w=(d||[]).map(m).map(g),y=(f||[]).map(m).map(g);for(const o of n){const l=g(o);(w.includes(l)||y.includes(l))&&c.add(`${l} (tag)`)}for(const o of r)for(const l of n){const t=g(l);if(!t)continue;(o.includes(t)||t.includes(o))&&c.add(t);const u={wheat:["flour","semolina","durum"],milk:["whey","casein","lactose"],peanut:["groundnut","arachis","peanut"],"tree nuts":["almond","hazelnut","walnut","cashew","pistachio"],egg:["albumin","ovalbumin","egg"],soy:["soy","soya","soybean","soy lecithin"],fish:["anchovy","cod","salmon","tuna","fish"],shellfish:["shrimp","crab","prawn","lobster"]};if(u[t])for(const x of u[t])o.includes(x)&&c.add(`${t} (${x})`)}for(const[o,l]of Object.entries(e||{}))if(!(!l||l.length===0))for(const t of l)for(const u of r)u.includes(t)&&c.add(`${o} (related:${t})`);return Array.from(c)}async function A(a,n,e=[]){const d=g(n);if(!d)return{found:!1,safe:null,productName:n,ingredients:[],allergens:[],message:"Empty query"};const{data:f}=await S.from("related_foods").select("*").eq("user_id",a).ilike("product_name",`%${d}%`).limit(10);if(f&&f.length){const t=f[0],u=(t.ingredients_text||"").toString().toLowerCase().split(/,|;|\(|\)|\n/).map(p=>p.trim()).filter(Boolean),x=await E(a,e),i=b(u,e,x,[],[]);return{found:!0,productName:t.product_name||n,ingredients:u,allergens:i,safe:i.length===0,source:"db"}}const c=await v(n,10);if(!c||c.length===0)return{found:!1,safe:null,productName:n,ingredients:[],allergens:[],message:"No product found"};let r=c.find(t=>t.ingredients&&t.ingredients.length)||c[0];const m=C(r),w=(r.allergens_tags||[]).map(t=>t.toString()),y=(r.traces_tags||[]).map(t=>t.toString()),o=await E(a,e),l=b(m,e,o,w,y);return{found:!0,productName:r.product_name||n,ingredients:m,allergens:l,safe:l.length===0,source:"openfoodfacts",chosenRaw:r}}function L(){const{user:a}=k(),n=a==null?void 0:a.id,[e,d]=h.useState(""),[f,c]=h.useState([]),[r,m]=h.useState(null),[w,y]=h.useState(!0),[o,l]=h.useState(!1),[t,u]=h.useState("");h.useEffect(()=>{n&&(async()=>{y(!0);const i=await _(n);c(i.map(p=>p.allergen.toLowerCase())),y(!1)})()},[n]);const x=async()=>{if(e.trim()){l(!0),m(null),u("");try{const i=await A(n,e,f);i.found?m(i):u(i.message||"Product not found")}catch(i){console.error("FoodSafety check error:",i),u("Unable to check product. Try again.")}l(!1)}};return w?s.createElement("div",null,"Loading your allergies..."):s.createElement("div",{className:"max-w-2xl mx-auto"},s.createElement("h1",{className:"text-3xl font-bold mb-4"},"Food Safety Checker"),s.createElement("p",{className:"text-gray-600 mb-4"},"Type a packaged product name (e.g., Snickers, Oreo). We'll fetch ingredients and check for allergens."),s.createElement("div",{className:"flex gap-3 mb-6"},s.createElement("input",{className:"flex-1 p-3 border rounded-lg",placeholder:"e.g., Snickers",value:e,onChange:i=>d(i.target.value)}),s.createElement("button",{onClick:x,disabled:o,className:"px-4 py-2 text-white rounded-lg",style:{background:"var(--sb-accent)",opacity:o?.7:1}},o?"Checking...":"Check")),t&&s.createElement("div",{className:"p-3 bg-red-100 text-red-700 rounded mb-4"},t),r&&s.createElement("div",{className:"p-5 bg-white rounded-xl shadow"},s.createElement("h2",{className:"text-xl font-semibold mb-2"},r.productName),s.createElement("p",{className:"text-sm text-gray-500 mb-2"},"Source: ",r.source),r.safe?s.createElement("p",{className:"text-green-600 font-semibold text-lg"},"SAFE ✔"):s.createElement(s.Fragment,null,s.createElement("p",{className:"text-red-600 font-semibold text-lg"},"UNSAFE ❌"),s.createElement("p",{className:"text-gray-700 mt-2"},"Detected allergens / hits:"),s.createElement("ul",{className:"list-disc ml-6 mt-2 text-red-600"},r.allergens.map((i,p)=>s.createElement("li",{key:p},i)))),s.createElement("div",{className:"mt-4"},s.createElement("h3",{className:"text-lg font-semibold mb-2"},"Ingredients"),r.ingredients.length>0?s.createElement("ul",{className:"list-disc ml-6 text-sm text-gray-700"},r.ingredients.map((i,p)=>s.createElement("li",{key:p},i))):s.createElement("p",{className:"text-sm text-gray-500"},"No ingredient data available."))))}export{L as default};
